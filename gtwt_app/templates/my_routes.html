<!-- prettier-ignore -->

{% extends "base.html" %}
{% load static %}
{% block title %}My Saved Routes{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/saved_routes.css' %}" />
{% endblock %} {% block content %}
<h2>My Saved Routes</h2>

{% if routes %}
<table class="route-table">
  <thead>
    <tr>
      <th style="width: 15%">Name</th>
      <th style="width: 25%">From</th>
      <th style="width: 25%">To</th>
      <th style="width: 7%">Distance</th>
      <th style="width: 8%">Duration</th>
      <th style="width: 20%">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for r in routes %}
    <tr data-route-id="{{ r.id }}">
      <td>
        <span class="route-name">{{ r.name }}</span>
        <input
          class="edit-name-input"
          type="text"
          value="{{ r.name }}"
          style="display: none; width: 100%"
        />
      </td>
      <td>{{ r.origin }}</td>
      <td>{{ r.destination }}</td>
      <td>{{ r.distance_text }}</td>
      <td>{{ r.duration_text }}</td>
      <td>
        <div style="display: flex; flex-direction: column; gap: 5px">
          <button
            class="route-btn load-route-btn"
            data-steps="{{ r.steps|escapejs }}"
          >
            Load
          </button>
          <button class="route-btn rename-btn">Rename</button>
          <button class="route-btn save-name-btn" style="display: none">
            Save
          </button>
          <button class="route-btn danger delete-route-btn">Delete</button>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p>You havenâ€™t saved any routes yet.</p>
{% endif %} {% endblock %} {% block extra_scripts %}
<script>
  document.querySelectorAll(".load-route-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const tr = btn.closest("tr");
      const steps = JSON.parse(tr.getAttribute("data-steps"));
      const origin = tr.children[1].innerText;
      const destination = tr.children[2].innerText;
      const mode = steps[0].mode || "WALKING"; // fallback

      directionsService.route(
        {
          origin,
          destination,
          travelMode: google.maps.TravelMode[mode],
        },
        (result, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(result);
          } else {
            alert("Error loading route: " + status);
          }
        }
      );
    });
  });
  document.querySelectorAll(".rename-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const tr = btn.closest("tr");
      tr.querySelector(".route-name").style.display = "none";
      tr.querySelector(".edit-name-input").style.display = "inline";
      btn.style.display = "none";
      tr.querySelector(".save-name-btn").style.display = "inline";
    });
  });

  document.querySelectorAll(".save-name-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const tr = btn.closest("tr");
      const newName = tr.querySelector(".edit-name-input").value;
      const routeId = tr.getAttribute("data-route-id");

      // Optimistically update UI
      tr.querySelector(".route-name").innerText = newName;
      tr.querySelector(".route-name").style.display = "inline";
      tr.querySelector(".edit-name-input").style.display = "none";
      btn.style.display = "none";
      tr.querySelector(".rename-btn").style.display = "inline";

      // Send update to backend
      fetch("/api/rename_route/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          id: routeId,
          name: newName,
        }),
      }).then((res) => {
        if (!res.ok) alert("Failed to rename route.");
      });
    });
  });

  document.querySelectorAll(".delete-route-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      if (!confirm("Are you sure you want to delete this route?")) return;

      const tr = btn.closest("tr");
      const routeId = tr.getAttribute("data-route-id");

      fetch("/api/delete_route/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ id: routeId }),
      }).then((res) => {
        if (res.ok) {
          tr.remove(); // Remove row from table
        } else {
          alert("Failed to delete route.");
        }
      });
    });
  });

  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
