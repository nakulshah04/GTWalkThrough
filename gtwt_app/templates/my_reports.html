{% extends "base.html" %} {% load static %} {% block content %}
<h2 style="margin-bottom: 1rem">My Submitted Zones</h2>
<div id="map" style="height: 600px; width: 100%; margin-bottom: 2rem"></div>

<!-- Pass zone data into JavaScript -->
<script id="zone-data" type="application/json">
  {{ zones|safe }}
</script>
{% endblock %} {% block extra_scripts %}
<script>
  let map;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 33.7756, lng: -84.3963 },
      zoom: 15,
    });

    const zones = JSON.parse(document.getElementById("zone-data").textContent);

    zones.forEach((zone) => {
      const polygon = new google.maps.Polygon({
        paths: zone.coordinates,
        fillColor: "#B3A369",
        fillOpacity: 0.4,
        strokeWeight: 2,
        map: map,
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `<div>
                    <strong>${zone.description}</strong><br>
                    Start: ${zone.start_date}<br>
                    End: ${zone.end_date}<br>
                    <button onclick="deleteZone(${zone.id})"
                      style="margin-top: 0.5rem; padding: 4px 8px; background-color: crimson; color: white; border: none; border-radius: 4px; cursor: pointer;">
                      Delete
                    </button>
                  </div>`,
      });

      polygon.addListener("click", () => {
        const center =
          zone.coordinates[Math.floor(zone.coordinates.length / 2)];
        infoWindow.setPosition(center);
        infoWindow.open(map);
      });
    });
  }

  function deleteZone(zoneId) {
    if (!confirm("Are you sure you want to delete this zone?")) return;

    fetch("/delete_zone/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({ id: zoneId }),
    })
      .then((res) => {
        if (res.ok) {
          alert("Zone deleted.");
          location.reload();
        } else {
          alert("Failed to delete the zone.");
        }
      })
      .catch((err) => {
        console.error("Error:", err);
        alert("An error occurred.");
      });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

<!-- Load Google Maps -->
<script
  async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDh85PgN2MrMRAVohVswxAJ3YSy_mwxmEA&callback=initMap"
></script>
{% endblock %}
